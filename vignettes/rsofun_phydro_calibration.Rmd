---
title: "Calibration of rsofun with Phydro"
author: "Jaideep Joshi"
date: "2023-09-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(reshape2)
library(rsofun)
```

## Generate data if not already available

```{r}
site <- "GF-Guy"
```

```{r}
load(paste0("../data/",site,"_p_hydro_drivers.rda"))
load(paste0("../data/",site,"_p_hydro_validation.rda"))

p_hydro_validation$data[[1]] = p_hydro_validation$data[[1]] %>% 
  rename(latenth=le) %>% 
  mutate(gpp = gpp*86400/1e6*12) %>% # convert to [gC m-2 day-1]
  mutate(latenth = latenth*86400)    # convert [W m-2] to [J m-2 day-1]

p_hydro_drivers$forcing[[1]]$netrad[is.na(p_hydro_drivers$forcing[[1]]$netrad)] = 0
p_hydro_drivers$forcing[[1]]$patm[p_hydro_drivers$forcing[[1]]$patm < 0] = 1.0135e5

```

Function to quickly run model and plot outputs

```{r}

plot_pmodel = function(params_modl){
  output_p <- rsofun::runread_pmodel_f(
    p_hydro_drivers,
    par = params_modl
  )
  
  p1 = output_p$data[[1]] %>% select(date, gpp, latenth) %>% 
    melt("date") %>% 
    mutate(group="model") %>% 
    rbind(p_hydro_validation$data[[1]] %>% 
            select(date, gpp, latenth) %>%
            # mutate(gpp = gpp*86400/1e6*12) %>% # convert to gC m-2 day-1
            # mutate(latenth = latenth*86400) %>%  # convert W m-2 to J m-2 day-1 
            melt("date") %>% 
            mutate(group="obs")) %>% 
    ggplot(aes(y=value, x=as.Date(date))) +
    geom_line(aes(group=group, col=group), alpha=0.7) +
    theme_classic() +
    theme(strip.background = element_rect(color = "white", size = 1))+
    facet_wrap(~variable, scales = "free", nrow = 2)
  
  p2 = output_p$data[[1]] %>% select(date, gpp, latenth) %>% 
    melt("date", value.name = "pred") %>% 
    left_join(p_hydro_validation$data[[1]] %>% 
            select(date, gpp, latenth) %>%
            # mutate(gpp = gpp*86400/1e6*12) %>% # convert to gC m-2 day-1
            # mutate(le = le*86400) %>%  # convert W m-2 to J m-2 day-1 
            melt("date", value.name = "obs")) %>% 
    ggplot(aes(y=obs, x=pred)) +
    geom_point(alpha=0.7) +
    geom_abline(slope=1, intercept=0, col="red")+
    theme_classic() +
    theme(strip.background = element_rect(color = "white", size = 1))+
    facet_wrap(~variable, scales = "free", nrow = 1)
  
  print(p1)
  print(p2)
}
```

```{r}
params_modl <- list(
  kphio              = 0.089, # 0.11, #0.04998,    
  kphio_par_a        = 0.0,        # set to zero to disable temperature-dependence of kphio
  kphio_par_b        = 1.0,
  soilm_thetastar    = 0.6 * 240,  # to recover old setup with soil moisture stress
  soilm_betao        = 0.0,
  beta_unitcostratio = 146.0,
  rd_to_vcmax        = 0.014,      # value from Atkin et al. 2015 for C3 herbaceous
  tau_acclim         = 30.0,
  kc_jmax            = 0.41,
  phydro_K_plant     = 0.3e-16,
  phydro_p50_plant   = -1,
  phydro_b_plant     = 1,
  phydro_alpha       = 0.1,
  phydro_gamma       = 1,
  bsoil              = 3,
  whc                = 90
)
```

## Model calibration

### P-model calibration (GenSA)

```{r}
p_hydro_drivers$params_siml[[1]]$use_phydro = F
p_hydro_drivers$params_siml[[1]]$use_pml = F

# Define calibration settings and parameter ranges from previous work
settings_rmse <- list(
  method = 'GenSA',                   # minimizes the RMSE
  metric = cost_rmse_pmodel,          # our cost function
  control = list(                     # control parameters for optimizer GenSA
    maxit = 100),                     
  par = list(                         # bounds for the parameter space
    kphio = list(lower=0.02, upper=0.2, init=0.05)
  ),
  parallel = T,
  ncores = 8
)

# Calibrate the model and optimize the free parameters using
# demo datasets
pars_calib_rmse <- calib_sofun(
  # calib_sofun arguments:
  drivers = p_hydro_drivers,  
  obs = p_hydro_validation,
  settings = settings_rmse,
  # extra arguments passed to the cost function:
  par_fixed = list(         # fix all other parameters
    kphio_par_a        = 0.0,        # set to zero to disable temperature-dependence 
    # of kphio, setup ORG
    kphio_par_b        = 1.0,
    soilm_thetastar    = 0.6 * 240,  # to recover paper setup with soil moisture stress
    soilm_betao        = 0.0,
    beta_unitcostratio = 146.0,
    rd_to_vcmax        = 0.014,      # value from Atkin et al. 2015 for C3 herbaceous
    tau_acclim         = 30.0,
    kc_jmax            = 0.41,
    whc                = 90
  ),
  targets = "gpp"           # define target variable GPP
)

print(pars_calib_rmse, max=20)

params_modl_opt = params_modl
params_modl_opt$kphio = pars_calib_rmse$par
plot_pmodel(params_modl_opt)

```

### P-model calibration (BayesianTools)

```{r}
p_hydro_drivers$params_siml[[1]]$use_phydro = F
p_hydro_drivers$params_siml[[1]]$use_pml = F

# Define calibration settings and parameter ranges from previous work
settings_bayes <- list(
  method = "BayesianTools",
  par = list(
    kphio = list(lower=0.04, upper=0.09, init=0.05),
    err_gpp = list(lower = 0.01, upper = 4, init = 2)
  ),
  metric = rsofun::cost_likelihood_pmodel,
  control = list(
    sampler = "DEzs",
    settings = list(
      nrChains = 1,
      burnin = 500,        
      iterations = 600     # kept artificially low
    )
  )
)

# Calibrate the model and optimize the free parameters using
# demo datasets
pars_calib_bayes <- calib_sofun(
  # calib_sofun arguments:
  drivers = p_hydro_drivers,  
  obs = p_hydro_validation,
  settings = settings_bayes,
  # extra arguments passed to the cost function:
  par_fixed = list(         # fix all other parameters
    kphio_par_a        = 0.0,        # set to zero to disable temperature-dependence 
    # of kphio, setup ORG
    kphio_par_b        = 1.0,
    soilm_thetastar    = 0.6 * 240,  # to recover paper setup with soil moisture stress
    soilm_betao        = 0.0,
    beta_unitcostratio = 146.0,
    rd_to_vcmax        = 0.014,      # value from Atkin et al. 2015 for C3 herbaceous
    tau_acclim         = 30.0,
    kc_jmax            = 0.41,
    whc                = 90
  ),
  targets = "gpp"           # define target variable GPP
)

print(pars_calib_bayes)

params_modl_opt = params_modl
params_modl_opt$kphio = pars_calib_bayes$par[["kphio"]]
plot_pmodel(params_modl_opt)

```

### P-hydro calibration (GenSA)

```{r}
p_hydro_drivers$params_siml[[1]]$use_phydro = T
p_hydro_drivers$params_siml[[1]]$use_pml = F

# Define calibration settings and parameter ranges from previous work
settings_rmse <- list(
  method = 'GenSA',                   # minimizes the RMSE
  metric = cost_rmse_pmodel,          # our cost function
  control = list(                     # control parameters for optimizer GenSA
    maxit = 100),                     
  par = list(
    kphio = list(lower=0.04, upper=0.09, init=0.05),
    phydro_K_plant = list(lower=0.05e-16, upper=5e-16, init=0.3e-16)
  ),
  parallel = T,
  ncores = 8
)

# Calibrate the model and optimize the free parameters using
# demo datasets
pars_calib_rmse <- calib_sofun(
  # calib_sofun arguments:
  drivers = p_hydro_drivers,  
  obs = p_hydro_validation,
  settings = settings_rmse,
  # extra arguments passed to the cost function:
  par_fixed = list(         # fix all other parameters
    kphio_par_a        = 0.0,        # set to zero to disable temperature-dependence of kphio
    kphio_par_b        = 1.0,
    rd_to_vcmax        = 0.014,      # value from Atkin et al. 2015 for C3 herbaceous
    tau_acclim         = 30.0,
    kc_jmax            = 0.41,
    # phydro_K_plant     = 0.3e-16,
    phydro_p50_plant   = -1,
    phydro_b_plant     = 1,
    phydro_alpha       = 0.1,
    phydro_gamma       = 1,
    bsoil              = 3,
    whc                = 90  
  ),
  targets = c("gpp", "latenth"),           # define target variable GPP
  target_weights = c(1, 1e-6)
)

print(pars_calib_rmse, max=20)

params_modl_opt = params_modl
params_modl_opt$kphio = pars_calib_rmse$par[["kphio"]]
params_modl_opt$phydro_K_plant = pars_calib_rmse$par[["phydro_K_plant"]]
plot_pmodel(params_modl_opt)

```

### P-hydro calibration (BayesianTools)

```{r}
p_hydro_drivers$params_siml[[1]]$use_phydro = T
p_hydro_drivers$params_siml[[1]]$use_pml = F

# Define calibration settings and parameter ranges from previous work
settings_bayes <- list(
  method = "BayesianTools",
  par = list(
    kphio = list(lower=0.04, upper=0.09, init=0.05),
    phydro_K_plant = list(lower=0.05e-16, upper=5e-16, init=0.3e-16),
    err_gpp = list(lower = 0.01, upper = 4, init = 2),
    err_le = list(lower = 0.01e7, upper = 4e7, init = 2e7)
  ),
  metric = rsofun::cost_likelihood_pmodel,
  control = list(
    sampler = "DEzs",
    settings = list(
      nrChains = 1,
      burnin = 1000,        
      iterations = 1300     # kept artificially low
    )
  )
)

# Calibrate the model and optimize the free parameters using
# demo datasets
pars_calib_bayes <- calib_sofun(
  # calib_sofun arguments:
  drivers = p_hydro_drivers,  
  obs = p_hydro_validation,
  settings = settings_bayes,
  # extra arguments passed to the cost function:
  par_fixed = list(         # fix all other parameters
    kphio_par_a        = 0.0,        # set to zero to disable temperature-dependence of kphio
    kphio_par_b        = 1.0,
    rd_to_vcmax        = 0.014,      # value from Atkin et al. 2015 for C3 herbaceous
    tau_acclim         = 30.0,
    kc_jmax            = 0.41,
    # phydro_K_plant     = 0.3e-16,
    phydro_p50_plant   = -1,
    phydro_b_plant     = 1,
    phydro_alpha       = 0.1,
    phydro_gamma       = 1,
    bsoil              = 3,
    whc                = 90  
  ),
  targets = c("gpp", "latenth")           # define target variable GPP
)

print(pars_calib_bayes)

params_modl_opt = params_modl
params_modl_opt$kphio = pars_calib_bayes$par[["kphio"]]
params_modl_opt$phydro_K_plant = pars_calib_bayes$par[["phydro_K_plant"]]
plot_pmodel(params_modl_opt)

```



### P-hydro full calibration (BayesianTools)

```{r}
p_hydro_drivers$params_siml[[1]]$use_phydro = T
p_hydro_drivers$params_siml[[1]]$use_pml = F

# Define calibration settings and parameter ranges from previous work
settings_bayes <- list(
  method = "BayesianTools",
  par = list(
    kphio = list(lower=0.04, upper=0.09, init=0.05),
    phydro_K_plant = list(lower=0.05e-16, upper=5e-16, init=0.3e-16),
    phydro_p50_plant = list(lower=-4, upper=-0.1, init=-1),
    phydro_alpha = list(lower=0.06, upper=0.15, init=0.1),
    phydro_gamma = list(lower=0.05, upper=2, init=1),
    bsoil = list(lower=1, upper=5, init=3),
    whc = list(lower=10, upper=1000, init=90),
    err_gpp = list(lower = 0.01, upper = 4, init = 2),
    err_le = list(lower = 0.01e7, upper = 4e7, init = 2e7)
  ),
  metric = rsofun::cost_likelihood_pmodel,
  control = list(
    sampler = "DEzs",
    settings = list(
      nrChains = 1,
      burnin = 1000,        
      iterations = 1300     # kept artificially low
    )
  )
)

# Calibrate the model and optimize the free parameters using
# demo datasets
pars_calib_bayes <- calib_sofun(
  # calib_sofun arguments:
  drivers = p_hydro_drivers,  
  obs = p_hydro_validation,
  settings = settings_bayes,
  # extra arguments passed to the cost function:
  par_fixed = list(         # fix all other parameters
    kphio_par_a        = 0.0,        # set to zero to disable temperature-dependence of kphio
    kphio_par_b        = 1.0,
    rd_to_vcmax        = 0.014,      # value from Atkin et al. 2015 for C3 herbaceous
    tau_acclim         = 30.0,
    kc_jmax            = 0.41,
    # phydro_K_plant     = 0.3e-16,
    # phydro_P50_plant     = -1,
    phydro_b_plant     = 1
    # phydro_alpha       = 0.1,
    # phydro_gamma       = 1,
    # bsoil              = 3,
    # whc                = 90  
  ),
  targets = c("gpp", "latenth")           # define target variable GPP
)

print(pars_calib_bayes)

params_modl_opt = params_modl
params_modl_opt$kphio = pars_calib_bayes$par[["kphio"]]
params_modl_opt$phydro_K_plant = pars_calib_bayes$par[["phydro_K_plant"]]
params_modl_opt$phydro_p50_plant = pars_calib_bayes$par[["phydro_p50_plant"]]
params_modl_opt$phydro_alpha = pars_calib_bayes$par[["phydro_alpha"]]
params_modl_opt$phydro_gamma = pars_calib_bayes$par[["phydro_gamma"]]
params_modl_opt$bsoil = pars_calib_bayes$par[["bsoil"]]
params_modl_opt$whc = pars_calib_bayes$par[["whc"]]

plot_pmodel(params_modl_opt)

```
