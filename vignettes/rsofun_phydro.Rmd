---
title: "Rsofun with Phydro"
author: "Jaideep Joshi"
date: "2023-09-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(reshape2)
```

## Generate data if not already available

```{r}


```

```{r}
site <- "GF-Guy"
generate_data = F

out_path = "~/Downloads/fluxdatakit_oct3/Phydro_drivers/"
```

```{r}
if (generate_data){

library(FluxDataKit)
  
lsm_path = "~/Downloads/fluxdatakit_oct3/FLUXDATAKIT_LSM/"
csv_path = "~/Downloads/fluxdatakit_oct3/FLUXDATAKIT_FLUXNET/"

files_csv = list.files(csv_path)
files_lsm = list.files(lsm_path)

# Get filename for HH data for matching site
file_csv = files_csv[intersect(grep(site, files_csv), 
                               grep("HH", files_csv))]

# get metadata
# --------------------------------------------------------
message("- reading Metadata for site")
meta <- suppressWarnings(
  try(
    fdk_convert_lsm(
      site = site,
      fluxnet_format = TRUE,
      path = lsm_path,
      meta_data = T
      )
    )
  )


# get half-hourly data  --------------------------------------------------------
# message("- convert to FLUXNET standard CSV file")
# hhdf <- suppressWarnings(
#   try(
#     fdk_convert_lsm(
#       site = site,
#       fluxnet_format = TRUE,
#       path = "~/Downloads/flux_data_kit_beta/fluxes/"
#       )
#     )
#   )
# 
# if(inherits(hhdf, "try-error")){
#   message("!!! conversion to FLUXNET failed  !!!")
#   return(NULL)
# }

message("- reading FLUXNET format data")
hhdf <- readr::read_csv(paste0(csv_path,"/",file_csv))

# Add date and time columns to hhdf for easier further processing.
# ---------------------------------------------------------
hhdf = 
  hhdf |>
    mutate(time = lubridate::as_datetime(as.character(TIMESTAMP_START), tz = "GMT", format="%Y%m%d%H%M")) |>
    mutate(date = lubridate::as_date(time))

# Aggregate to daily 24-hr means  ----------------------------------------------------------
message("- downsampling FLUXNET format - 24 hr means")
ddf_24hr_mean <-
  try(
    hhdf |>
    group_by(date) |>
    select(-TIMESTAMP_START, -TIMESTAMP_END) |>
    summarize_all(.funs = mean)
  )

# Check aggregation
ddf_24hr_mean %>% 
  select(SW_IN_F_MDS, SW_OUT, LW_IN_F_MDS, LAI, FPAR, GPP_DT_VUT_REF, LE_F_MDS, TA_F_MDS, date) %>% 
  mutate(albedo = SW_OUT/SW_IN_F_MDS) %>% 
  melt("date") %>% 
  ggplot(aes(y=value, x=date)) + 
  geom_line(col="aquamarine4") + 
  theme_classic() +
  theme(strip.background = element_rect(color = "white", size = 1))+
  facet_wrap(~variable, scales = "free")
```

```{r}
valid_years = read.csv(text = "
    sitename  , start_year ,  end_year \n
    GF-Guy    , 2004       ,  2015     \n
    FR-Pue    , 2004       ,  2020     \n
    FI-Hyy    , 2004       ,  2020     \n
    CH-Dav    , 2004       ,  2020     \n
    ", 
    header=T, strip.white=T)

# Get valid data years
ystart = valid_years %>% filter(sitename==site) %>% pull(start_year)
yend = valid_years %>% filter(sitename==site) %>% pull(end_year)

# Aggregate around daily maximum ppfd for acclimating model
# ---------------------------------------------------------
test.3day = hhdf %>% filter(date >= as_date(paste0(floor((ystart+yend)/2),"-06-01")) &
                            date <= as_date(paste0(floor((ystart+yend)/2),"-06-03")) ) 

aggregate_daily_3hr_maxima = function(df){
  # Get the time at which SW_IN is maximum
  maxppfd <- df %>% filter(SW_IN_F_MDS == max(SW_IN_F_MDS))
  max_t <- maxppfd$time[1]
  
  # Select times that lie in 3-hr interval around max_t
  df_aroundmax <- df %>% filter(time < (max_t + 1.5*3600) & 
                                time > (max_t - 1.5*3600) )

  # take mean of selected entries
  df_mean <- df_aroundmax |>
    select(-TIMESTAMP_START, -TIMESTAMP_END) |>
    summarize_all(.funs = mean)
  
  df_mean
}

# Test aggregation
# ----------------
test.3day.3hr = test.3day %>% group_by(date) %>% do(aggregate_daily_3hr_maxima(.)) %>% ungroup()

test.3day %>% select(time, SW_IN_F_MDS, NETRAD, TA_F_MDS, VPD_F_MDS, GPP_NT_VUT_REF, GPP_DT_VUT_REF, LE_F_MDS, LAI, FPAR) %>% 
  melt("time") %>% 
  mutate(type="hourly") %>% 
  rbind(test.3day.3hr %>% 
          select(time, SW_IN_F_MDS, NETRAD, TA_F_MDS, VPD_F_MDS, GPP_NT_VUT_REF, GPP_DT_VUT_REF, LE_F_MDS, LAI, FPAR) %>% 
          melt("time") %>% 
          mutate(type="daily")
  ) %>% 
  ggplot(aes(y=value, x=as.POSIXct(time))) + 
  geom_line(data = . %>% filter(type == "hourly"), col="aquamarine4") + 
  geom_point(data = . %>% filter(type == "daily")) + 
  theme_classic() +
  theme(strip.background = element_rect(color = "white", size = 1))+
  facet_wrap(~variable, scales = "free")
```

```{r}
# Apply 3hr maxima aggregation to all data
# ----------------------------------------
message("- downsampling FLUXNET format - daily 3-hr means around max ppfd")
ddf_3hr_maxima <- hhdf |>
  group_by(date) |>
  do(aggregate_daily_3hr_maxima(.)) |>
  ungroup()
```

```{r}
aggregate_daily_daylength = function(df){
  # Get the time at which SW_IN > 0 
  pos_ppfd <- df %>% filter(SW_IN_F_MDS > 10)
  tmax <- max(pos_ppfd$time)
  tmin <- min(pos_ppfd$time)
  
  # Select times that lie in 3-hr interval around max_t
  df_aroundmax <- df %>% filter(time <= tmax & 
                                time >= tmin )

  # take mean of selected entries
  df_mean <- df_aroundmax |>
    select(-TIMESTAMP_START, -TIMESTAMP_END) |>
    summarize_all(.funs = mean) |> 
    mutate(daylength = difftime(tmax, tmin, units="hours") |> as.numeric())

  df_mean
}

# Test aggregation
# ----------------
test.3day.daylen = test.3day %>% group_by(date) %>% do(aggregate_daily_daylength(.)) %>% ungroup()

test.3day %>% select(time, SW_IN_F_MDS, NETRAD, TA_F_MDS, VPD_F_MDS, GPP_NT_VUT_REF, GPP_DT_VUT_REF, LE_F_MDS, LAI) %>%
  mutate(daylength = NA) %>% 
  melt("time") %>% 
  mutate(type="hourly") %>% 
  rbind(test.3day.daylen %>% 
          select(time, SW_IN_F_MDS, NETRAD, TA_F_MDS, VPD_F_MDS, GPP_NT_VUT_REF, GPP_DT_VUT_REF, LE_F_MDS, LAI, daylength) %>% 
          melt("time") %>% 
          mutate(type="daily")
  ) %>% 
  ggplot(aes(y=value, x=as.POSIXct(time))) + 
  geom_line(data = . %>% filter(type == "hourly"), col="aquamarine4") + 
  geom_point(data = . %>% filter(type == "daily")) + 
  theme_classic() +
  theme(strip.background = element_rect(color = "white", size = 1))+
  facet_wrap(~variable, scales = "free")
```

```{r}
# Apply daytime mean aggregation to all data
# ------------------------------------------
message("- downsampling FLUXNET format - daytime means")
ddf_daytime_mean <- hhdf |>
  group_by(date) |>
  do(aggregate_daily_daylength(.)) |>
  ungroup()

# Check daylength seasonality
ddf_daytime_mean %>% 
  ggplot(aes(y=daylength, x=date)) +
  geom_line()+
  theme_classic()
```

```{r}
# Calculate daily tmax and tmin from hh data
# ------------------------------------------
tmaxmin <- 
  hhdf |> 
  group_by(date) |>
  summarize(
    tmax = max(TA_F_MDS),
    tmin = min(TA_F_MDS)
  )
```

```{r}
# Creating driver object  ------------------------------------------------------
message("- compiling drivers")
load("../data/p_model_drivers.rda")

p_hydro_drivers <- p_model_drivers
p_hydro_drivers$sitename[[1]] = site
p_hydro_drivers$site_info[[1]] = 
    tibble(
       lon=meta[[1]]$longitude, 
       lat=meta[[1]]$latitude, 
       elv = meta[[1]]$elevation,
       canopy_height=meta[[1]]$canopy_height, 
       reference_height = meta[[1]]$reference_height
    )
kfFEC = 2.04

start_year = ystart
end_year = yend

# for demo, use just a subset of years
p_hydro_drivers$forcing <- 
  ddf_24hr_mean |>
  dplyr::filter(lubridate::year(date) %in% start_year:end_year) |>
  dplyr::filter(!(lubridate::mday(date) == 29 & lubridate::month(date) == 2)) |>
  left_join(tmaxmin) |>
  group_by(date) |>
  summarize(
    date = date,
    temp = TA_F_MDS, 
    vpd = VPD_F_MDS * 100, 
    ppfd = SW_IN_F_MDS * kfFEC * 1e-06, 
    netrad = NETRAD, 
    patm = PA_F * 1000, 
    snow = 0, 
    rain = P_F * 48 /(60 * 60 * 24), # P_F [mm timestep-1] * 48 [timesteps day-1] / 86400 [secs day-1 ]
    tmin = tmin, # TMIN_F_MDS, 
    tmax = tmax, # TMAX_F_MDS, 
    fapar = FPAR, 
    co2 = CO2_F_MDS,
    ccov = 0
  ) |>
  list()

p_hydro_drivers$forcing_acclim <- 
  ddf_3hr_maxima |>
  dplyr::filter(lubridate::year(date) %in% start_year:end_year) |>
  dplyr::filter(!(lubridate::mday(date) == 29 & lubridate::month(date) == 2)) |>
  left_join(tmaxmin) |>
  group_by(date) |>
  summarize(
    date = date,
    time = time,
    temp = TA_F_MDS, 
    vpd = VPD_F_MDS * 100, 
    ppfd = SW_IN_F_MDS * kfFEC * 1e-06, 
    netrad = NETRAD, 
    patm = PA_F * 1000, 
    snow = 0, 
    rain = NA, # P_F * 48 / (60 * 60 * 24), 
    tmin = tmin, # TMIN_F_MDS, 
    tmax = tmax, # TMAX_F_MDS, 
    fapar = FPAR, 
    co2 = CO2_F_MDS,
    ccov = 0   
  ) |>
  list()

p_hydro_drivers$forcing_daytime_mean <- 
  ddf_daytime_mean |>
  dplyr::filter(lubridate::year(date) %in% start_year:end_year) |>
  dplyr::filter(!(lubridate::mday(date) == 29 & lubridate::month(date) == 2)) |>
  left_join(tmaxmin) |>
  group_by(date) |>
  summarize(
    date = date,
    time = time,
    temp = TA_F_MDS, 
    vpd = VPD_F_MDS * 100, 
    ppfd = SW_IN_F_MDS * kfFEC * 1e-06, 
    netrad = NETRAD, 
    patm = PA_F * 1000, 
    snow = 0, 
    rain = NA,  # P_F * 48 / (60 * 60 * 24), 
    tmin = tmin, # TMIN_F_MDS, 
    tmax = tmax, # TMAX_F_MDS, 
    fapar = FPAR, 
    co2 = CO2_F_MDS,
    ccov = 0,
    daylength = daylength
  ) |>
  list()


p_hydro_drivers$forcing_halfhourly <- 
  hhdf |>
  dplyr::filter(lubridate::year(date) %in% start_year:end_year) |>
  dplyr::filter(!(lubridate::mday(date) == 29 & lubridate::month(date) == 2)) |>
  group_by(time) |>
  summarize(
    date = date,
    time = time,
    temp = TA_F_MDS, 
    vpd = VPD_F_MDS * 100, 
    ppfd = SW_IN_F_MDS * kfFEC * 1e-06, 
    netrad = NETRAD, 
    patm = PA_F * 1000, 
    snow = 0, 
    rain = P_F * 48 / (60 * 60 * 24), 
    fapar = FPAR, 
    co2 = CO2_F_MDS,
    ccov = 0
  ) |>
  list()


# write all drivers to file
# apply compression to minimize space
filn <- paste0(out_path, "/",site,"_p_hydro_drivers.rda")
message(paste0("- writing to file: ", filn))
save(p_hydro_drivers,
     file = filn
     )  


# Write validation data
load("../data/p_model_validation.rda")

p_hydro_validation <- p_model_validation
p_hydro_validation$sitename[[1]] = site

p_hydro_validation$data <- 
  ddf_24hr_mean |>
  dplyr::filter(lubridate::year(date) %in% start_year:end_year) |>
  dplyr::filter(!(lubridate::mday(date) == 29 & lubridate::month(date) == 2)) |>
  group_by(date) |>
    summarise(
      date = date,
      time = time,
      gpp = GPP_DT_VUT_REF,
      latenth = LE_F_MDS
    ) |>
  mutate(gpp = gpp*86400/1e6*12)  |>    # convert to [gC m-2 day-1]
  mutate(latenth = latenth*86400) |>    # convert [W m-2] to [J m-2 day-1]
  list()

p_hydro_validation$data_hh <- 
  hhdf |>
    dplyr::filter(lubridate::year(date) %in% start_year:end_year) |>
    dplyr::filter(!(lubridate::mday(date) == 29 & lubridate::month(date) == 2)) |>
    group_by(time) |>
    summarise(
      date = date,
      time = time,
      gpp = GPP_DT_VUT_REF,
      latenth = LE_F_MDS
    ) |>
  mutate(gpp = gpp*86400/1e6*12)  |>    # convert to [gC m-2 day-1]
  mutate(latenth = latenth*86400) |>    # convert [W m-2] to [J m-2 day-1]
  list()

p_hydro_validation$data_3hr_mean <- 
  ddf_3hr_maxima |>
    dplyr::filter(lubridate::year(date) %in% start_year:end_year) |>
    dplyr::filter(!(lubridate::mday(date) == 29 & lubridate::month(date) == 2)) |>
    group_by(time) |>
    summarise(
      date = date,
      time = time,
      gpp = GPP_DT_VUT_REF,
      latenth = LE_F_MDS
    ) |>
  mutate(gpp = gpp*86400/1e6*12)  |>    # convert to [gC m-2 day-1]
  mutate(latenth = latenth*86400) |>    # convert [W m-2] to [J m-2 day-1]
  list()

p_hydro_validation$data_daytime_mean <- 
  ddf_daytime_mean |>
    dplyr::filter(lubridate::year(date) %in% start_year:end_year) |>
    dplyr::filter(!(lubridate::mday(date) == 29 & lubridate::month(date) == 2)) |>
    group_by(time) |>
    summarise(
      date = date,
      time = time,
      gpp = GPP_DT_VUT_REF,
      latenth = LE_F_MDS
    ) |>
  mutate(gpp = gpp*86400/1e6*12)  |>    # convert to [gC m-2 day-1]
  mutate(latenth = latenth*86400) |>    # convert [W m-2] to [J m-2 day-1]
  list()


filn <- paste0(out_path,"/",site,"_p_hydro_validation.rda")
message(paste0("- writing to file: ", filn))
save(p_hydro_validation,
     file = filn
     )  


}

```

## Read Phydro drivers and check

```{r}
# rm(list=ls())

load(paste0("../data/",site,"_p_hydro_drivers.rda"))
load(paste0("../data/",site,"_p_hydro_validation.rda"))

p_hydro_drivers$forcing[[1]]$netrad[is.na(p_hydro_drivers$forcing[[1]]$netrad)] = 0
p_hydro_drivers$forcing[[1]]$patm[p_hydro_drivers$forcing[[1]]$patm < 0] = 1.0135e5

start_date = "2011-06-01"
end_date = "2011-06-06"

# Check acclimation data against half-hourly
# ---
p_hydro_drivers$forcing_halfhourly[[1]] %>%
filter(date >= start_date & date <= end_date ) %>%   
  select(time, ppfd, netrad, temp, vpd, fapar) %>% 
  melt("time") %>% 
  mutate(type="hourly") %>% 
  rbind(p_hydro_drivers$forcing_acclim[[1]] %>%
          filter(date >= start_date & date <= end_date ) %>%
          select(time, ppfd, netrad, temp, vpd, fapar) %>% 
          melt("time") %>% 
          mutate(type="daily")
  ) %>% 
  ggplot(aes(y=value, x=as.POSIXct(time))) + 
  geom_line(data = . %>% filter(type == "hourly"), col="aquamarine4") + 
  geom_point(data = . %>% filter(type == "daily")) + 
  theme_classic() +
  theme(strip.background = element_rect(color = "white", size = 1))+
  facet_wrap(~variable, scales = "free")


# Check daily-3hr-maxima against daytime_means against 24 hr means
# ---
start_date = "2011-06-01"
end_date = "2015-06-03"

p_hydro_drivers$forcing[[1]] %>%
  filter(date >= start_date & date <= end_date ) %>%
  select(date, ppfd, netrad, temp, vpd, fapar) %>% 
  melt("date") %>% 
  mutate(type="24-hr mean") %>% 
  rbind(p_hydro_drivers$forcing_acclim[[1]] %>%
          filter(date >= start_date & date <= end_date ) %>%
          select(date, ppfd, netrad, temp, vpd, fapar) %>% 
          melt("date") %>% 
          mutate(type="3-hr maxima")
  ) %>% 
  rbind(p_hydro_drivers$forcing_daytime_mean[[1]] %>%
          filter(date >= start_date & date <= end_date ) %>%
          select(date, ppfd, netrad, temp, vpd, fapar) %>% 
          melt("date") %>% 
          mutate(type="daytime means")
  ) %>% 
  ggplot(aes(y=value, x=date)) + 
  geom_line(aes(group=type, col=type), alpha=0.5) + 
  theme_classic() +
  theme(strip.background = element_rect(color = "white", size = 1))+
  facet_wrap(~variable, scales = "free")


start_date = "2011-06-01"
end_date = "2015-06-03"

p_hydro_validation$data[[1]] %>%
  filter(date >= start_date & date <= end_date ) %>%
  select(date, gpp, le) %>% 
  melt("date") %>% 
  mutate(type="24-hr mean") %>% 
  rbind(p_hydro_validation$data_3hr_mean[[1]] %>%
          filter(date >= start_date & date <= end_date ) %>%
          select(date, gpp, le) %>% 
          melt("date") %>% 
          mutate(type="3-hr maxima")
  ) %>% 
  rbind(p_hydro_validation$data_daytime_mean[[1]] %>%
          filter(date >= start_date & date <= end_date ) %>%
          select(date, gpp, le) %>% 
          melt("date") %>% 
          mutate(type="daytime means")
  ) %>% 
  ggplot(aes(y=value, x=date)) + 
  geom_line(aes(group=type, col=type), alpha=0.5) + 
  theme_classic() +
  theme(strip.background = element_rect(color = "white", size = 1))+
  facet_wrap(~variable, scales = "free")


```

## Model parameters and driver data

Liu et al 21 nature climate change alexandra konings

Qs:

"Compound extremes are more reliably simulated with a hydraulics-explicit model"

1.  disaggregating SM and VPD - compund stress

Kim novick Nat CC - interactions between VPD and SM with flux data

plot model bias \~ SM, VPD, T, does bias increase at extremes?

How to test interactions.

2. site scale calibrations - generalizability of params, systematic variation in hydraulic traits with climate? Within-site Variation in hydraulic traits? Relative CV of params - e.g. hyd traits vary but cost params are relatively constant? 

3. uncertainty in WHC and b for hydrualic response? 

```{r}
params_modl <- list(
  kphio              = 0.089, # 0.11, #0.04998,    # setup ORG in Stocker et al. 2020 GMD
  kphio_par_a        = 0.0,        # set to zero to disable temperature-dependence of kphio
  kphio_par_b        = 1.0,
  soilm_thetastar    = 0.6 * 240,  # to recover old setup with soil moisture stress
  soilm_betao        = 0.0,
  beta_unitcostratio = 146.0,
  rd_to_vcmax        = 0.014,      # value from Atkin et al. 2015 for C3 herbaceous
  tau_acclim         = 30.0,
  kc_jmax            = 0.41,
  phydro_K_plant     = 0.3e-16,
  phydro_p50_plant   = -1,
  phydro_b_plant     = 1,
  phydro_alpha       = 0.1,
  phydro_gamma       = 1,
  bsoil              = 3,
  whc                = 90
)

p_hydro_drivers$forcing[[1]] %>% 
  # dplyr::filter(lubridate::year(date) %in% 2007:2013) %>% 
  melt("date") %>% 
  ggplot(aes(y=value, x=as.Date(date))) +
  geom_line(col="aquamarine4") +
  theme_classic() +
  theme(strip.background = element_rect(color = "white", size = 1))+
  facet_wrap(~variable, scales = "free")


# load("../data/p_model_drivers.rda")
# load("../data/p_model_validation.rda")
# p_model_drivers$forcing[[1]] %>% 
#   melt("date") %>% 
#   ggplot(aes(y=value, x=as.Date(date))) +
#   geom_line(col="aquamarine4") +
#   theme_classic() +
#   theme(strip.background = element_rect(color = "white", size = 1))+
#   facet_wrap(~variable, scales = "free")
```

## Model run

### P-model run

```{r}
p_hydro_drivers$params_siml[[1]]$use_phydro = F
p_hydro_drivers$params_siml[[1]]$use_pml = F

output_p <- rsofun::runread_pmodel_f(
  p_hydro_drivers,
  par = params_modl
)
```

### P-model Validation

```{r}
output_p$data[[1]] %>% select(date, gpp, latenth) %>% 
  rename(le = latenth) %>% 
  melt("date") %>% 
  mutate(group="model") %>% 
  rbind(p_hydro_validation$data[[1]] %>% 
          select(date, gpp, le) %>%
          mutate(gpp = gpp*86400/1e6*12) %>% # convert to gC m-2 day-1
          mutate(le = le*86400) %>%  # convert W m-2 to J m-2 day-1 
          melt("date") %>% 
          mutate(group="obs")) %>% 
  ggplot(aes(y=value, x=as.Date(date))) +
  geom_line(aes(group=group, col=group), alpha=0.7) +
  theme_classic() +
  theme(strip.background = element_rect(color = "white", size = 1))+
  facet_wrap(~variable, scales = "free", nrow = 2)
```

### P-hydro run

```{r}
p_hydro_drivers$params_siml[[1]]$use_phydro = T
p_hydro_drivers$params_siml[[1]]$use_pml = F

output_ph <- rsofun::runread_pmodel_f(
  p_hydro_drivers,
  par = params_modl
)
```

### P-hydro Validation

```{r}
output_ph$data[[1]] %>% select(date, gpp, latenth) %>% 
  rename(le = latenth) %>% 
  melt("date") %>% 
  mutate(group="model") %>% 
  rbind(p_hydro_validation$data[[1]] %>% 
          select(date, gpp, le) %>%
          mutate(gpp = gpp*86400/1e6*12) %>% # convert to gC m-2 day-1
          mutate(le = le*86400) %>%  # convert W m-2 to J m-2 day-1 
          melt("date") %>% 
          mutate(group="obs")) %>% 
  ggplot(aes(y=value, x=as.Date(date))) +
  geom_line(aes(group=group, col=group), alpha=0.7) +
  theme_classic() +
  theme(strip.background = element_rect(color = "white", size = 1))+
  facet_wrap(~variable, scales = "free", nrow = 2)
```

```{r}

output_ph$data[[1]] %>% select(date, gpp, latenth) %>% 
  rename(le = latenth) %>% 
  melt("date", value.name = "pred") %>% 
  left_join(p_hydro_validation$data[[1]] %>% 
          select(date, gpp, le) %>%
          mutate(gpp = gpp*86400/1e6*12) %>% # convert to gC m-2 day-1
          mutate(le = le*86400) %>%  # convert W m-2 to J m-2 day-1 
          melt("date", value.name = "obs")) %>% 
  ggplot(aes(y=obs, x=pred)) +
  geom_point(alpha=0.7) +
  geom_abline(slope=1, intercept=0, col="red")+
  theme_classic() +
  theme(strip.background = element_rect(color = "white", size = 1))+
  facet_wrap(~variable, scales = "free", nrow = 1)
```

### P-hydro run (with PM ET)

```{r}
p_hydro_drivers$params_siml[[1]]$use_phydro = T
p_hydro_drivers$params_siml[[1]]$use_pml = T

output_ph_pm <- rsofun::runread_pmodel_f(
  p_hydro_drivers,
  par = params_modl
)
```

### P-hydro Validation (with PM ET)

```{r}
output_ph_pm$data[[1]] %>% select(date, gpp, latenth) %>% 
  rename(le = latenth) %>% 
  melt("date") %>% 
  mutate(group="model") %>% 
  rbind(p_hydro_validation$data[[1]] %>% 
          select(date, gpp, le) %>%
          mutate(gpp = gpp*86400/1e6*12) %>% # convert to gC m-2 day-1
          mutate(le = le*86400) %>%  # convert W m-2 to J m-2 day-1 
          melt("date") %>% 
          mutate(group="obs")) %>% 
  ggplot(aes(y=value, x=as.Date(date))) +
  geom_line(aes(group=group, col=group), alpha=0.7) +
  theme_classic() +
  theme(strip.background = element_rect(color = "white", size = 1))+
  facet_wrap(~variable, scales = "free", nrow = 2)
```

```{r}

output_ph_pm$data[[1]] %>% select(date, gpp, latenth) %>% 
  rename(le = latenth) %>% 
  melt("date", value.name = "pred") %>% 
  left_join(p_hydro_validation$data[[1]] %>% 
          select(date, gpp, le) %>%
          mutate(gpp = gpp*86400/1e6*12) %>% # convert to gC m-2 day-1
          mutate(le = le*86400) %>%  # convert W m-2 to J m-2 day-1 
          melt("date", value.name = "obs")) %>% 
  ggplot(aes(y=obs, x=pred)) +
  geom_point(alpha=0.7) +
  geom_abline(slope=1, intercept=0, col="red")+
  theme_classic() +
  theme(strip.background = element_rect(color = "white", size = 1))+
  facet_wrap(~variable, scales = "free", nrow = 1)
```

```{r}
output_ph$data[[1]] %>% select(-year_dec) %>% 
  melt("date") %>% 
  mutate(model = "phydro") %>%
  rbind(
    output_p$data[[1]] %>% select(-year_dec) %>% 
    melt("date") %>% 
    mutate(model = "pmodel")
  ) %>% 
  filter(!is.infinite(value)) %>% 
  ggplot(aes(y=value, x=as.Date(date), group=model, col=model)) +
  geom_line(alpha=0.5) +
  theme_classic() +
  theme(strip.background = element_rect(color = "white", size = 1))+
  facet_wrap(~variable, scales = "free")


output_ph_pm$data[[1]] %>% select(-year_dec) %>% 
  melt("date") %>% 
  mutate(model = "phydro_pm") %>%
  rbind(
    output_ph$data[[1]] %>% select(-year_dec) %>% 
    melt("date") %>% 
    mutate(model = "phydro_diff")
  ) %>% 
  filter(!is.infinite(value)) %>% 
  ggplot(aes(y=value, x=as.Date(date), group=model, col=model)) +
  geom_line(alpha=0.5) +
  theme_classic() +
  theme(strip.background = element_rect(color = "white", size = 1))+
  facet_wrap(~variable, scales = "free")
```
