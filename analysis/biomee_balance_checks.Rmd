---
title: "BiomeE balance checks"
author: "Beni Stocker"
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(rsofun)
library(dplyr)
library(ggplot2)
library(rsofun)
```


## Run model

Running the BiomeE model with P-model photosynthesis

```{r}
# run the model
out <- runread_biomee_f(
     biomee_p_model_drivers,
     makecheck = TRUE,
     parallel = FALSE
     )
```


## Check balances

Check mass balances from the annual tile-level output.
```{r}
out$data[[1]]$output_annual_tile |> 
  as_tibble()
```

### Woody biomass growth - Mortality = 0

`NPPW`: Woody biomass growth, units of gC m-2 yr-1. 

`m_turnover`: Mortality is all live biomass loss, corresponding to biomass transfer to litter pools, units of gC m-2 yr-1.

```{r}
len <- nrow(out$data[[1]]$output_annual_tile)

tibble(
  year = out$data[[1]]$output_annual_tile$year,
  npp  = out$data[[1]]$output_annual_tile$NPPW,
  mort = out$data[[1]]$output_annual_tile$m_turnover
  ) |> 
  mutate(balance = mort - npp) |> 
  ggplot(aes(year, balance)) +
  geom_line()
```

**Issues**

- `vegn_species_switch()`: what's this?

### $\Delta$Plant C = biomass production

```{r}
len <- nrow(out$data[[1]]$output_annual_tile)
tibble(
  year = out$data[[1]]$output_annual_tile$year[1:(len-1)],
  dcplant = out$data[[1]]$output_annual_tile$plantC[2:len] - 
    out$data[[1]]$output_annual_tile$plantC[1:(len-1)],
  npp = out$data[[1]]$output_annual_tile$NPP[1:(len-1)]
  ) |> 
  mutate(balance = dcplant - npp) |> 
  ggplot(aes(year, balance)) +
  geom_line()
```

Balance not satisfied.




